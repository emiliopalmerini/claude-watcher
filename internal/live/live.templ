package live

import (
	"fmt"
	"claude-watcher/internal/shared/templates"
)

templ Live(data LiveData) {
	@templates.Layout("Live Sessions") {
		<div class="page-header">
			<h1>Live Sessions</h1>
			<div class="auto-refresh">
				<span class="auto-refresh__dot"></span>
				<span>Auto-refresh every 5s</span>
			</div>
		</div>
		<section>
			<h2>Active Now</h2>
			<div
				id="live-sessions-grid"
				hx-get="/live/sessions"
				hx-trigger="every 5s"
				hx-swap="innerHTML"
			>
				@LiveSessionsGrid(data.ActiveSessions)
			</div>
		</section>
		if len(data.RecentSessions) > 0 {
			<section class="recent-sessions">
				<h2>Recent (last 2 hours)</h2>
				<div class="live-grid">
					for _, session := range data.RecentSessions {
						@RecentSessionCard(session)
					}
				</div>
			</section>
		}
	}
}

templ LiveSessionsGrid(sessions []LiveSession) {
	if len(sessions) == 0 {
		<div class="live-empty">
			<div class="live-empty__icon">-</div>
			<div class="live-empty__text">No active sessions in the last 30 minutes</div>
		</div>
	} else {
		<div class="live-grid">
			for _, session := range sessions {
				@LiveSessionCard(session)
			}
		</div>
	}
}

templ LiveSessionCard(session LiveSession) {
	<div class={ "live-card", templ.KV("live-card--active", session.Status == "active") }>
		<div class="live-card__header">
			<span class="live-card__session-id">{ session.SessionID }</span>
			<div class="live-card__status">
				<span class={ "live-indicator", indicatorClass(session.Status) }></span>
				<span class="live-card__time">{ session.LastActivity }</span>
			</div>
		</div>
		<div class="live-card__project" title={ session.WorkingDir }>{ session.WorkingDir }</div>
		<div class="live-card__stats">
			<div class="live-card__stat">
				<span class="live-card__stat-value">{ formatDuration(session.Duration) }</span>
				<span class="live-card__stat-label">Duration</span>
			</div>
			<div class="live-card__stat">
				<span class="live-card__stat-value">{ formatTokens(session.Tokens) }</span>
				<span class="live-card__stat-label">Tokens</span>
			</div>
		</div>
		<div class="live-card__velocity">
			<div class="live-card__velocity-header">
				<span class="live-card__velocity-label">Burn Rate</span>
				<span class="live-card__velocity-value">{ fmt.Sprintf("%.0f", session.TokensPerMinute) } tok/min</span>
			</div>
			<div class="live-card__velocity-bar">
				<div class="live-card__velocity-fill" style={ velocityWidth(session.TokensPerMinute) }></div>
			</div>
		</div>
	</div>
}

templ RecentSessionCard(session LiveSession) {
	<div class="live-card">
		<div class="live-card__header">
			<span class="live-card__session-id">{ session.SessionID }</span>
			<span class="live-card__time">{ session.LastActivity }</span>
		</div>
		<div class="live-card__project" title={ session.WorkingDir }>{ session.WorkingDir }</div>
		<div class="live-card__stats">
			<div class="live-card__stat">
				<span class="live-card__stat-value">{ formatDuration(session.Duration) }</span>
				<span class="live-card__stat-label">Duration</span>
			</div>
			<div class="live-card__stat">
				<span class="live-card__stat-value">{ session.Hostname }</span>
				<span class="live-card__stat-label">Host</span>
			</div>
		</div>
	</div>
}

func indicatorClass(status string) string {
	switch status {
	case "idle":
		return "live-indicator--idle"
	case "stale":
		return "live-indicator--stale"
	default:
		return ""
	}
}

func formatDuration(seconds int64) string {
	if seconds < 60 {
		return fmt.Sprintf("%ds", seconds)
	}
	minutes := seconds / 60
	if minutes < 60 {
		return fmt.Sprintf("%dm", minutes)
	}
	hours := minutes / 60
	mins := minutes % 60
	return fmt.Sprintf("%dh%dm", hours, mins)
}

func formatTokens(n int64) string {
	if n >= 1000000 {
		return fmt.Sprintf("%.1fM", float64(n)/1000000)
	}
	if n >= 1000 {
		return fmt.Sprintf("%.1fK", float64(n)/1000)
	}
	return fmt.Sprintf("%d", n)
}

func velocityWidth(tokensPerMin float64) string {
	// Scale: 0-500 tok/min = 0-100%
	pct := tokensPerMin / 500 * 100
	if pct > 100 {
		pct = 100
	}
	return fmt.Sprintf("width: %.1f%%", pct)
}
